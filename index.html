<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Webhook Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0; min-height:100vh; background:#000;
  display:flex; justify-content:center; align-items:center;
  font-family:system-ui,sans-serif; color:#fee2e2;
}
.container{
  width:94%; max-width:560px; padding:24px;
  background:linear-gradient(145deg,#1a0000,#000);
  border-radius:18px; border:1px solid #7f1d1d;
}
h1{text-align:center;margin-bottom:18px;font-size:26px}
input,textarea{
  width:100%; margin-top:10px; padding:13px;
  border-radius:12px; background:#000; color:#fee2e2;
  border:1px solid #7f1d1d; font-size:14px;
}
.tokens{height:120px}
.msg{height:130px}
.row{display:flex; gap:10px}
.row input{flex:1}
button{
  width:100%; margin-top:12px; padding:14px;
  font-size:15px; font-weight:bold; border-radius:14px;
  border:none; cursor:pointer; color:#fff;
}
.send{background:#dc2626}
.pause{background:#92400e}
.stop{background:#374151}
.status{margin-top:10px; text-align:center; font-size:13px}
.log{
  margin-top:10px; font-size:12px;
  max-height:110px; overflow:auto;
}
.small{font-size:11px; opacity:.8}
</style>
</head>

<body>
<div class="container">
  <h1>Webhook</h1>

  <textarea id="urls" class="tokens"
    placeholder="Webhook URLを改行で最大50個まで"></textarea>

  <input id="name" placeholder="Webhook名">

  <textarea id="msg" class="msg" maxlength="500"
    placeholder="送信メッセージ（最大500文字）"></textarea>

  <div class="row">
    <input id="interval" type="number" value="1000" min="100"
      placeholder="間隔(ms)">
    <input id="limit" type="number"
      placeholder="回数（空＝無限）">
  </div>

  <button class="send" onclick="start()">実行</button>
  <button class="pause" onclick="togglePause()">一時停止 / 再開</button>
  <button class="stop" onclick="stop()">停止</button>

  <div class="status" id="status">待機中</div>
  <div class="status small">
    総送信: <span id="count">0</span> /
    現在URL: <span id="current">-</span>
  </div>
  <div class="log" id="log"></div>
</div>

<script>
let timer=null, running=false, paused=false;
let urls=[], index=0, count=0;
let stats=new Map(); // url -> success count
let backoffUntil=0;

const els={
  urls:urlsEl=document.getElementById("urls"),
  msg:msgEl=document.getElementById("msg"),
  name:nameEl=document.getElementById("name"),
  interval:intervalEl=document.getElementById("interval"),
  limit:limitEl=document.getElementById("limit"),
  status:statusEl=document.getElementById("status"),
  count:countEl=document.getElementById("count"),
  current:document.getElementById("current"),
  log:document.getElementById("log")
};

function log(t){
  els.log.innerHTML+=t+"<br>";
  if(els.log.children.length>200){
    els.log.innerHTML=els.log.innerHTML.split("<br>").slice(-150).join("<br>");
  }
  els.log.scrollTop=els.log.scrollHeight;
}

function save(){
  localStorage.setItem("wh_cfg",JSON.stringify({
    urls:els.urls.value, msg:els.msg.value,
    name:els.name.value, interval:els.interval.value,
    limit:els.limit.value
  }));
}
function load(){
  const d=JSON.parse(localStorage.getItem("wh_cfg")||"null");
  if(!d) return;
  Object.keys(d).forEach(k=>els[k].value=d[k]||"");
}
load();

function start(){
  if(running) return;

  urls=els.urls.value.split("\n").map(v=>v.trim()).filter(Boolean);
  if(urls.length===0) return statusEl.textContent="Webhookなし";
  if(urls.length>50) return statusEl.textContent="最大50個";
  if(!els.msg.value.trim()) return statusEl.textContent="メッセージ空";

  save();
  running=true; paused=false; count=0; index=0;
  stats.clear(); backoffUntil=0;
  countEl.textContent="0";
  statusEl.textContent="送信中";
  log(`▶ 開始 (${urls.length})`);

  timer=setInterval(tick, parseInt(els.interval.value)||1000);
}

function tick(){
  if(!running || paused) return;
  if(Date.now()<backoffUntil) return;

  const limit=parseInt(els.limit.value)||Infinity;
  if(count>=limit){ stop(); return; }

  const url=urls[index];
  els.current.textContent=index+1;
  send(url);
  index=(index+1)%urls.length;
}

function send(url){
  fetch(url,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      content:els.msg.value,
      username:els.name.value||"Webhook"
    })
  }).then(r=>{
    if(r.status===429){
      backoffUntil=Date.now()+3000;
      log("⚠ レート制限 3秒待機");
      return;
    }
    count++; countEl.textContent=count;
    stats.set(url,(stats.get(url)||0)+1);
    log(`✔ 成功 (${stats.get(url)})`);
  }).catch(()=>log("✖ 失敗"));
}

function togglePause(){
  if(!running) return;
  paused=!paused;
  statusEl.textContent=paused?"一時停止中":"送信中";
  log(paused?"⏸ 停止":"▶ 再開");
}

function stop(){
  clearInterval(timer); timer=null;
  running=false; paused=false;
  statusEl.textContent="停止";
  log("■ 停止");
}
</script>
</body>
</html>
